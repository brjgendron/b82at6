<!DOCTYPE html>
<html>
  <head>
    <title>Chat.js</title>
    <!-- <style>
      form { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; }
      form input { border: 0; padding: 10px; width: 90%; margin-right: .5%; }
      form button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
      #messages { list-style-type: none; margin: 0; padding: 0; }
      #messages li { padding: 5px 10px; }
			#messages li:nth-child(odd) { background: #eee; }
			#sender { font-weight: bold; }
		</style> -->
		<link rel="stylesheet" href="stylesheets/variables.css">
		<link rel="stylesheet" href="stylesheets/reset.css">
		<link rel="stylesheet" href="stylesheets/chatbox.css">
		<link rel="stylesheet" href="stylesheets/messages.css">
		<link rel="stylesheet" href="stylesheets/users.css">
	</head>
	
	<script src="/socket.io/socket.io.js"></script>
	<script src="https://code.jquery.com/jquery-1.11.1.js"></script>
	<script src="js/linkify.min.js"></script>
	<!-- <script src="linkify-jquery.min.js"></script> -->
	<script>
		$(function () {
			var socket = io();
			$('form').submit(function(e){
				e.preventDefault(); // prevents page reloading
				if ($("#chatbox").val().length > 0) {
					if ($("#chatbox").val().length <= 2500) {
						socket.emit('chat message', $('#chatbox').val());
						$('#chatbox').val('');
					} else {
						alert(`Your messages exceeds the character limit of 2500`);
					}
				}
				return false;
			});

			socket.on('chat message', function(msg, userID, time, color){
				let links = linkify.find(msg);
				// let link = [];
				let formattedMsg = msg;
				for (var i = 0; i < links.length; i++) {
					// link.push(`<a href=\"${links[i].href}\" target="_blank">${links[i].href}</a>`);
					formattedMsg = msg.replace(links[i].href, `<a href=\"${links[i].href}\" target="_blank">${links[i].href}</a>`);
					console.log(links[i].href);
				}
				console.log(links);
				console.log(msg);
				// console.log(link);
				console.log(formattedMsg);

				$('#messages').append(
					$('<li>').append(
						$("<span>", {class : "time"}).text(`[${time}] `)
					).append(
						$("<span>", {class : userID}).text(`${userID}: `)
					).append(
						$("<span>", {class : "message-text"}).text(`${msg}`)
					)
				);

				// for (var i = 0; i < links.length; i++) {
				// 	link = `<a href=\"${links[i].href}\">${links[i].href}</a>`;
				
				// 	$(".message-text").append(link);
				// }

				$(`.${userID}`).css({"color":color});
				$(`.${userID}`).css({"font-weight":"500"});

				var messagesContainer = document.getElementById("messages-container");
				messagesContainer.scrollTop = messagesContainer.scrollHeight + 50;
			});

			socket.on("user disconnect", function(userID, color, currentUsers) {
				$("#users").empty();
				for (var i = 0; i < currentUsers.length; i++) {
					$('#users').append(
						$('<li>', {class : currentUsers[i][0]}).text(currentUsers[i][0])
					);
					
					$(`.${currentUsers[i][0]}`).css({"color":currentUsers[i][1]});
					$(`.${currentUsers[i][0]}`).css({"font-weight":"500"});
				}

				$('#messages').append(
					$('<li>').append(
						$("<span>").text("User ").append(
							$("<span>", {class : userID}).text(`${userID} `)
						).append(
							$("<span>").text("has left")
						)
					)
				);

				$(`.${userID}`).css({"color":color});
				$(`.${userID}`).css({"font-weight":"500"});
			});

			socket.on("user connect", function(userID, color, users) {
				// $('#users').append(
				// 		$('<li>', {class : users.splice(-1)[0][0]}).text(users.splice(-1)[0][0])
				// );
				$("#users").empty();
				for (var i = 0; i < users.length; i++) {
					$('#users').append(
						$('<li>', {class : users[i][0]}).text(users[i][0])
					);
					$(`.${users[i][0]}`).css({"color":users[i][1]});
					$(`.${users[i][0]}`).css({"font-weight":"500"});
				}
				// }
				// if (!$("#users").has(`.${userID}`) /*#users does not contain .userID*/) {
				// }

				// console.log();
				
				$('#messages').append(
					$('<li>').append(
						$("<span>").text("User ").append(
							$("<span>", {class : userID}).text(`${userID} `)
						).append(
							$("<span>").text("has joined")
						)
					)
				);
				$(`.${userID}`).css({"color":color});
				$(`.${userID}`).css({"font-weight":"500"});
			});
		});
	</script>

	<body>
		<div id="messages-container">
			<ul id="messages"></ul>
		</div>

		<div id="users-container">
			<ul id="users"></ul>
		</div>

		<div id="chatbox-container">
			<form id="compose" action="">
				<input id="chatbox" autocomplete="off" placeholder="Write a message" autofocus>
				<!-- <button id="send">Send</button> -->
			</form>
		</div>
	</body>
</html>